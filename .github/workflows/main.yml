name: Continuous Integration

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: Build on Linux via Docker Compose
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build plugin inside container
      run: docker compose -f docker/docker-compose.yml up --build --abort-on-container-exit

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: HammerIdFix-linux
        path: build/addons

  build-windows:
    name: Build on Windows (MSVC)
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Configure + Build with MSVC
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake -S . -B build -A x64 -DCMAKE_BUILD_TYPE=Release
        cmake --build build --config Release --target HammerIdFix

    - name: Strip symbols (Windows)
      run: |
        llvm-strip build/Release/HammerIdFix.dll

    - name: Copy addons structure
      run: |
        mkdir -p build/addons/HammerIdFix/bin/win64
        copy build/Release/HammerIdFix.dll build/addons/HammerIdFix/bin/win64/

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: HammerIdFix-windows
        path: build/addons

  release:
    name: Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Download Linux artifact
      uses: actions/download-artifact@v4
      with:
        name: HammerIdFix-linux
        path: ./build/linux

    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: HammerIdFix-windows
        path: ./build/windows

    - name: Archive packages
      run: |
        version="${GITHUB_REF#refs/tags/}"
        tar -czf HammerIdFix-${version}-linux.tar.gz -C build/linux .
        tar -czf HammerIdFix-${version}-windows.tar.gz -C build/windows .

    - name: Upload release archive
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: HammerIdFix-*.tar.gz
        tag: ${{ github.ref }}
        file_glob: true
        release_name: "${{ github.ref_name }} - Download"
